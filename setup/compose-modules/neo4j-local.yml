# Neo4j local database deployment
# Use this when deploying Neo4j in the swarm
# NOTE: This file is concatenated into swarm-stack.yml - no top-level 'services:' key
  neo4j:
    image: neo4j:5-community
    volumes:
      - ${DATA_ROOT}/neo4j_data:/data
      - ${DATA_ROOT}/neo4j_logs:/logs
    networks:
      - backend
    secrets:
      - "XXX_CHANGE_ME_DB_PASSWORD_XXX"
    environment:
      NEO4J_AUTH_FILE: /run/secrets/XXX_CHANGE_ME_DB_PASSWORD_XXX
      NEO4J_server_memory_heap_initial__size: 512m
      NEO4J_server_memory_heap_max__size: 2G
      NEO4J_server_memory_pagecache_size: 1G
      # Disable authentication for internal network (optional, remove for production)
      # NEO4J_AUTH: none
    deploy:
      mode: replicated
      replicas: ${NEO4J_REPLICAS}
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 2G
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 30s
