# Testing Directory

This directory contains all testing-related files for the Swarm Python API Template setup wizard.

## Contents

### Test Scripts
- **`test-build.sh`** - Automated test script that simulates the config-builder logic
  - Tests PostgreSQL + Traefik configuration
  - Tests PostgreSQL + Direct Port configuration
  - Verifies no placeholders remain
  - Validates correct injection of labels/ports

### Validation Scripts
- **`validate-stack.sh`** - Bash validation script for generated swarm-stack.yml
- **`validate-stack.ps1`** - PowerShell validation script for generated swarm-stack.yml

Both validation scripts check:
- No unreplaced `###` placeholders
- Valid YAML syntax (if Docker is available)
- Correct structure (services, networks, secrets)
- Proper proxy configuration (Traefik labels OR ports, not both)

### Documentation
- **`TESTING_SCENARIOS.md`** - Comprehensive testing guide with 4 scenarios:
  1. PostgreSQL Local + Traefik
  2. PostgreSQL Local + No Proxy
  3. PostgreSQL External + Traefik
  4. Neo4j Local + Traefik

### Examples
- **`examples/`** - Directory containing correct output examples
  - `swarm-stack-traefik-postgres-local.yml` - Example with Traefik
  - `swarm-stack-direct-postgres-local.yml` - Example with direct ports
  - `README.md` - Guide to using example files

### Test Output Files
- **`test-output-traefik.yml`** - Generated by test-build.sh (Traefik scenario)
- **`test-output-direct.yml`** - Generated by test-build.sh (Direct port scenario)

## Running Tests

### Automated Build Test
Tests the template injection logic without running the full wizard:

```bash
# Linux/Mac/WSL
cd testing
sh test-build.sh
```

This will:
1. Simulate the config-builder logic
2. Generate test output files
3. Verify no placeholders remain
4. Check for correct proxy configuration

### Validate Generated Stack File
After running the setup wizard, validate the output:

```bash
# Linux/Mac
cd testing
./validate-stack.sh ../swarm-stack.yml

# Windows
cd testing
.\validate-stack.ps1 ..\swarm-stack.yml
```

### Compare with Examples
Compare your generated file with the examples:

```bash
# Linux/Mac
diff ../swarm-stack.yml examples/swarm-stack-traefik-postgres-local.yml

# Windows
Compare-Object (Get-Content ..\swarm-stack.yml) (Get-Content examples\swarm-stack-traefik-postgres-local.yml)
```

## Test Results

### Latest Test Run
✅ **All tests passed!**

**Test 1: PostgreSQL Local + Traefik**
- ✅ No placeholders found
- ✅ Traefik labels found
- ✅ No ports section found

**Test 2: PostgreSQL Local + Direct Port**
- ✅ No placeholders found
- ✅ Ports section found
- ✅ No Traefik labels found

## What Gets Tested

### Template Injection
1. **Base structure** - services: key and redis service
2. **API service** - Built from api.template.yml with:
   - Database environment variables injected
   - Proxy network injected (if Traefik)
   - Proxy labels OR ports injected
3. **Database service** - Added if local deployment
4. **Footer** - Networks and secrets sections

### Validation Checks
1. **No unreplaced placeholders** - All `###PLACEHOLDER###` should be gone
2. **Correct proxy config** - Either Traefik labels OR ports, not both
3. **Valid YAML** - Syntax check with Docker (if available)
4. **Required sections** - services, networks, secrets, api, redis

## Troubleshooting

### Test Fails: "Found unreplaced placeholders"
**Cause:** Template injection logic is not working correctly.
**Fix:** Check that snippet files exist and sed commands target correct placeholders.

### Test Fails: "Traefik labels not found"
**Cause:** Labels snippet not injected or wrong placeholder targeted.
**Fix:** Verify `proxy-traefik.labels.yml` exists and `###PROXY_LABELS###` is being replaced.

### Test Fails: "Ports section not found"
**Cause:** Ports snippet not injected or wrong placeholder targeted.
**Fix:** Verify `proxy-none.ports.yml` exists and `###PROXY_PORTS###` is being replaced.

## Integration with Setup Wizard

The test-build.sh script replicates the exact logic used in:
- `setup/modules/config-builder.sh` (lines 41-110)
- `setup/modules/config-builder.ps1` (lines 45-134)

If tests pass here, the setup wizard should work correctly.

## Continuous Testing

Run tests after any changes to:
- `setup/modules/config-builder.sh` or `.ps1`
- `setup/compose-modules/api.template.yml`
- `setup/compose-modules/snippets/*.yml`

This ensures the template injection logic remains correct.
